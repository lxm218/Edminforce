{"version":3,"sources":["meteor://ğŸ’»app/server/cron/main.js"],"names":[],"mappings":"eAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"/server/cron/main.js","sourcesContent":["/**\n * Created on 9/20/15.\n */\n\n\n\n//Todo using linux crontab for performance reason?\nMeteor.startup(function () {\n\n    //æ ‡è®°è¿‡æœŸè´­ç‰©è½¦\n    function changeStaus() {\n\n        //è®¾ç½®activeä¸º expired\n        DB.ShoppingCart.update({\n            // 15åˆ†ä»¥å†…çš„ todo save time as config value\n            lastModified: {$lt: new Date(+new Date() - 15 * 60 * 1000)},\n            status: 'active'\n        }, {\n            $set: {\n                status: 'expiring'\n            }\n        }, {\n            multi: true\n        });\n    }\n\n    //expiring è´­ç‰©è½¦çš„å¤„ç†  ç¡®ä¿æ­¤è¿‡ç¨‹åå¤æ‰§è¡Œç»“æœä¸å˜\n    function clearShoppingCart() {\n\n        var carts = DB.ShoppingCart.find({\n            status: 'expiring'\n        })\n\n        //æ¢å¤classå¯ç”¨æ•°é‡\n        carts.forEach(function (cart, i, a) {\n\n            var item = cart.items //è·å–è´­ç‰©è½¦çš„è´­ç‰©é¡¹\n\n\n            var result;\n            var hasError = false;\n            cart.items.forEach(function (item, i_items, a_items) {\n\n\n                ///////////////æ¢å¤é€»è¾‘///////////////////////\n\n                if (cart.type == 'change') {//changeè¯¾ç¨‹\n\n\n                } else {//å¢åŠ è¯¾ç¨‹  å–æ¶ˆè¯¾ç¨‹\n\n                    //todo more test.  maybe $elemMatch is necessary\n                    result = DB.Classes.update({\n                        _id: item.classId,\n\n                        'carted.swimmerId': item.swimmerId,\n                        'carted.cart_id': cart['id'],\n                        'carted.qty': item['quantity']\n\n                    }, {\n                        '$inc': {seatsRemain: item.quantity},\n                        '$pull': {\n                            'carted': {'cartId': cart['id']}\n                        }\n                    })\n\n                    if (!result) {\n                        hasError = true;  //æœ‰é¡¹ç›®æœªæˆåŠŸæ¢å¤\n                    }\n                }\n\n            })\n\n\n            //è´­ç‰©è½¦æ‰€æœ‰é¡¹ç›®çš†æ¢å¤å®Œæ¯•\n            if (!hasError) {\n\n                DB.ShoppingCart.update({\n                    _id: cart._id\n                }, {\n                    $set: {\n                        status: 'expired'\n                    }\n                });\n            }\n\n        })\n\n        //æ¸…é™¤è¿‡æœŸè´­ç‰©è½¦\n        //DB.ShoppingCart.remove({\n        //    status:'expired'\n        //})\n\n    }\n\n\n    //http://docs.mongodb.org/ecosystem/use-cases/inventory-management/\n    //æ¸…é™¤æ‰€å¯¹åº”è´­ç‰©è½¦å·²ä¸å­˜åœ¨çš„class register\n    //case  è´­ç‰©è½¦expired å…ˆåˆ é™¤æ³¨å†Œä¿¡æ¯ å†åˆ é™¤è´­ç‰©è½¦\n    //case classæ³¨å†Œä¿¡æ¯å­˜åœ¨ å¯¹åº”è´­ç‰©è½¦ä¸å­˜åœ¨\n    //todo check all case\n    SyncedCron.add({\n        name: 'Clear Shopping Cart',\n        schedule: function (parser) {\n\n            return parser.text('every 15 minutes');\n            //return parser.text('every 10 seconds');\n\n        },\n        job: function () {\n            changeStaus()\n            clearShoppingCart()\n\n        }\n    });\n\n\n    SyncedCron.start()\n\n})\n\n\n\n"]}